3. The flattening needs to generate the correct eq_ and str_ code for each expanded thing
4. Maybe add support for detecting AST types and using the appropriate eq_ and str_ functions
